<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>controllers/posts-controller.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#approvePost">approvePost</a></li><li><a href="global.html#createPost">createPost</a></li><li><a href="global.html#deletePost">deletePost</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#getPosts">getPosts</a></li><li><a href="global.html#jwt">jwt</a></li><li><a href="global.html#mysql">mysql</a></li><li><a href="global.html#updatePost">updatePost</a></li><li><a href="global.html#uploadFiles">uploadFiles</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">controllers/posts-controller.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const { getConnection } = require("../database/database");
const fs = require('fs');
const path = require('path');

/**
 * @description Crea una nueva publicación
 */
const createPost = async (req, res) => {
  try {
    const { titulo, descripcion, precio, ubicacion, tipo } = req.body;

    if (!titulo || !descripcion || !precio || !ubicacion || !tipo) {
      return res.status(400).json({ ok: false, msg: 'Faltan campos obligatorios' });
    }

    let imageNames = [];

    if (!req.files || !req.files.imagenes) {
      return res.status(400).json({ ok: false, msg: 'Debe subir al menos una imagen' });
    }

    const images = Array.isArray(req.files.imagenes) ? req.files.imagenes : [req.files.imagenes];
    imageNames = images.map(file => file.name);

    const usuario_id = req.user.id; // Asegúrate de que JWT funcione correctamente

    const [result] = await pool.query(
      `INSERT INTO posts (titulo, descripcion, precio, ubicacion, tipo, imagenes, usuario_id)
             VALUES (?, ?, ?, ?, ?, JSON_ARRAY_PACK(?), ?)`,
      [titulo, descripcion, precio, ubicacion, tipo, JSON.stringify(imageNames), usuario_id]
    );

    const postId = result.insertId;

    return res.status(201).json({
      ok: true,
      post: {
        id: postId,
        titulo,
        descripcion,
        precio,
        ubicacion,
        tipo,
        imagenes: imageNames,
        usuario_id
      }
    });

  } catch (err) {
    console.error(err);
    return res.status(500).json({ ok: false, msg: 'Error al crear la publicación' });
  }
};

/**
 * @description Obtiene todas las publicaciones
 */
const getPosts = async (req, res) => {
  const connection = await getConnection();
  try {
    const [rows] = await connection.query(`
            SELECT *, JSON_UNQUOTE(JSON_EXTRACT(imagenes, '$')) AS imagenes 
            FROM posts WHERE estado != 'eliminado'
        `);

    return res.json({ ok: true, posts: rows });
  } catch (err) {
    console.error(err);
    return res.status(500).json({ ok: false, msg: 'Error al obtener las publicaciones' });
  }
};

/**
 * @description Actualiza una publicación
 */
const updatePost = async (req, res) => {
  const connection = await getConnection();
  try {
    const { id } = req.params;
    const { titulo, descripcion, precio, ubicacion, tipo } = req.body;

    // Validar existencia de la publicación
    const [existing] = await connection.query('SELECT * FROM posts WHERE id = ?', [id]);

    if (existing.length === 0 || existing[0].estado === 'eliminado') {
      return res.status(404).json({ ok: false, msg: 'Publicación no encontrada' });
    }

    // Permitir actualizar solo si es propietario o admin
    const isOwner = existing[0].usuario_id === req.user.id;
    if (!isOwner &amp;&amp; !req.user.roles.includes('admin')) {
      return res.status(403).json({ ok: false, msg: 'No tienes permiso para actualizar esta publicación' });
    }

    // Actualizar datos
    await connection.query(
      `UPDATE posts SET titulo = ?, descripcion = ?, precio = ?, ubicacion = ?, tipo = ?
             WHERE id = ?`,
      [titulo, descripcion, precio, ubicacion, tipo, id]
    );

    return res.json({ ok: true, msg: 'Publicación actualizada correctamente' });

  } catch (err) {
    console.error(err);
    return res.status(500).json({ ok: false, msg: 'Error al actualizar la publicación' });
  } finally {
    connection.release();
  }
};

/**
 * @description Elimina (lógicamente) una publicación
 */
const deletePost = async (req, res) => {
  const connection = await getConnection();
  try {
    const { id } = req.params;

    const [post] = await connection.query('SELECT * FROM posts WHERE id = ?', [id]);

    if (post.length === 0 || post[0].estado === 'eliminado') {
      return res.status(404).json({ ok: false, msg: 'Publicación no encontrada' });
    }

    const isOwner = post[0].usuario_id === req.user.id;
    if (!isOwner &amp;&amp; !req.user.roles.includes('admin')) {
      return res.status(403).json({ ok: false, msg: 'No tienes permiso para eliminar esta publicación' });
    }

    await connection.query(`UPDATE posts SET estado = 'eliminado' WHERE id = ?`, [id]);

    return res.json({ ok: true, msg: 'Publicación eliminada correctamente' });

  } catch (err) {
    console.error(err);
    return res.status(500).json({ ok: false, msg: 'Error al eliminar la publicación' });
  } finally {
    connection.release();
  }
};

/**
 * @description Aprueba una publicación (solo admin)
 */
const approvePost = async (req, res) => {
  const connection = await getConnection();
  try {
    const { id } = req.params;

    const [post] = await connection.query('SELECT * FROM posts WHERE id = ?', [id]);

    if (post.length === 0 || post[0].estado === 'eliminado') {
      return res.status(404).json({ ok: false, msg: 'Publicación no encontrada' });
    }

    if (post[0].estado === 'aprobado') {
      return res.status(400).json({ ok: false, msg: 'La publicación ya está aprobada' });
    }

    await connection.query(`UPDATE posts SET estado = 'aprobado' WHERE id = ?`, [id]);

    return res.json({ ok: true, msg: 'Publicación aprobada correctamente' });

  } catch (err) {
    console.error(err);
    return res.status(500).json({ ok: false, msg: 'Error al aprobar la publicación' });
  } finally {
    connection.release();
  }
};

module.exports = { createPost, getPosts, updatePost, deletePost, approvePost };</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Fri May 30 2025 16:01:48 GMT-0300 (hora estándar de Argentina) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
